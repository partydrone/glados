---

sudo: required

env:
  ACTION_CABLE_ALLOWED_REQUEST_ORIGINS: http:\/\/localhost*
  ACTION_CABLE_BACKEND_URL:             redis://:yourpassword@redis:6379/0
  ACTION_CABLE_FRONTEND_URL:            ws://localhost:28080
  ACTION_MAILER_DEFAULT_FROM:           webmaster@wavetronix.com
  ACTION_MAILER_DEFAULT_TO:             partydrone@gmail.com
  ACTION_MAILER_HOST:                   localhost:3000
  ACTIVE_JOB_QUEUE_PREFIX:              glados:jobs
  ACTIVE_JOB_URL:                       redis://:yourpassword@redis:6379/0
  AWS_S3_BUCKET:                        aporter-macbook
  AWS_S3_REGION:                        us-east-1
  BIND_ON:                              0.0.0.0:3000
  COMPOSE_PROJECT_NAME:                 glados
  DATABASE_URL:                         postgresql://postgres@postgres:5432/glados_test?encoding=unicode&pool=5&timeout=5000
  DOCKER_COMPOSE_VERSION:               1.8.1
  LOG_LEVEL:                            debug
  RAILS_ENV:                            test
  RAILS_MAX_THREADS:                    1
  REDIS_CACHE_URL:                      redis://:yourpassword@redis:6379/0/cache
  REQUEST_TIMEOUT:                      5
  SECRET_KEY_BASE:                      asecuretokenwouldnormallygohere
  SMTP_ADDRESS:                         email-smtp.us-east-1.amazonaws.com
  SMTP_AUTH:                            login
  SMTP_DOMAIN:                          wavetronix.com
  SMTP_ENABLE_STARTTLS_AUTO:            true
  SMTP_PORT:                            587
  WEB_CONCURRENCY:                      1

language: ruby

services:
  - docker

before_install:
  - mv -f docker-compose.travis.yml docker-compose.yml
  - mv -f config/database.travis.yml config/database.yml

  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - docker-compose --version

  - docker-compose build
  - docker-compose up -d
  - docker-compose ps

  - docker-compose run --rm app rails db:create RAILS_ENV=test

script:
  - docker-compose run --rm app rails test

# sudo: false
# language: ruby
# rvm:
#   - 2.2.5
#   - 2.3.1
# cache: bundler
# addons:
#   code_climate:
#     repo_token: 212a4731d9077e8b4227d940d95693c4c8fcfd5cee2f70623aab445206f05bdf
#   postgresql: '9.4'
#
# script:
#   - RAILS_ENV=test bundle exec rails db:migrate --trace
#   - bundle exec rails db:test:prepare
#
# before_script:
#   - psql -c "create database travis_ci_test;" -U postgres
#   - cp config/database.travis.yml config/database.yml
#   - cp config/secrets.travis.yml config/secrets.yml
# deploy:
#   - provider: opsworks
#     access_key_id: AKIAICOHX55UFK6DX4IA
#     secret_access_key:
#       secure: K71l/oBDP8skXeFRisINbVJANZ6NVi1ZyfFELFX1ovjCZzN8MEIxocmYouFd9l5i4rO6vQCTlZnhWLBhaHvUtMeV2qfpIuer3GwcklgBjemuHaTWjYHOtg9yzn9adyD5At4HglstXP5C15mJaRiGMpARdWDBqO6ulOa1HJV+WulsWwEPA8F8oxYKicuS55cJWThROT9i1ueIf2UEKDoMaAyF515BY4CdEFn75CM71rinValHEpT1VRvo11OOut6kU5IbvJne6kZhqOGFPQrwcL71rezFlCfS4stQrJdjlmOTy52RX2YKDt76FeSsbAnP4IzXyGc+rbVeCU7mTshYUgw+Ks6Gy9k9yOmV1ggng4CBofvC4g6+6x5wAmgPI8MS0vgQdnhCVQEJT2ydukciecFfwQHKepT5rguGxXcWZWj7X9otJDXhjcEv+4X+tvdSLaJwCnBzwsPtu9adc+0/puzfswpJzIkeVNb+gawrVf9U7PDqOAZ3a9naB7qhWCTbObcUUeDMmQvoY9I0K8VoFtGqREAhE4c3+iTm6bwNN3R6L006ldhtYpyy4zdryrqGGPTBztMKwNHH7blFfirGQP4aqleGzQ9coFawXrGC8i2w0ivy1Etuqx8AHGIGtLgrqXw84xzhyLDYCOCe/qoQzKaLe7iKCPnTknSi0ur24tQ=
#     app-id: 157075a2-1a57-43e5-bdbd-87e1fce7c01c
#     on:
#       repo: wavetronix/glados
#       branch: develop
#       rvm: 2.2.3
#   - provider: opsworks
#     access_key_id: AKIAICOHX55UFK6DX4IA
#     secret_access_key:
#       secure: K71l/oBDP8skXeFRisINbVJANZ6NVi1ZyfFELFX1ovjCZzN8MEIxocmYouFd9l5i4rO6vQCTlZnhWLBhaHvUtMeV2qfpIuer3GwcklgBjemuHaTWjYHOtg9yzn9adyD5At4HglstXP5C15mJaRiGMpARdWDBqO6ulOa1HJV+WulsWwEPA8F8oxYKicuS55cJWThROT9i1ueIf2UEKDoMaAyF515BY4CdEFn75CM71rinValHEpT1VRvo11OOut6kU5IbvJne6kZhqOGFPQrwcL71rezFlCfS4stQrJdjlmOTy52RX2YKDt76FeSsbAnP4IzXyGc+rbVeCU7mTshYUgw+Ks6Gy9k9yOmV1ggng4CBofvC4g6+6x5wAmgPI8MS0vgQdnhCVQEJT2ydukciecFfwQHKepT5rguGxXcWZWj7X9otJDXhjcEv+4X+tvdSLaJwCnBzwsPtu9adc+0/puzfswpJzIkeVNb+gawrVf9U7PDqOAZ3a9naB7qhWCTbObcUUeDMmQvoY9I0K8VoFtGqREAhE4c3+iTm6bwNN3R6L006ldhtYpyy4zdryrqGGPTBztMKwNHH7blFfirGQP4aqleGzQ9coFawXrGC8i2w0ivy1Etuqx8AHGIGtLgrqXw84xzhyLDYCOCe/qoQzKaLe7iKCPnTknSi0ur24tQ=
#     app-id: d8f7b51a-3c15-429a-9ec4-5b82488bdfaf
#     on:
#       repo: wavetronix/glados
#       branch: master
#       rvm: 2.2.2
